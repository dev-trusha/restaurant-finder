<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card shadow">
            <div class="card-body p-5">
                <h2 class="card-title text-center mb-4">ðŸ”‘ Login</h2>
                
                {{#if error}}
                    <div class="alert alert-danger">{{error}}</div>
                {{/if}}
                
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" name="email" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" placeholder="Enter your password" required>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            Login
                        </button>
                        <a href="/auth/register" class="btn btn-outline-secondary">
                            Don't have an account? Register
                        </a>
                    </div>
                </form>
                
                <div id="loginMessage" class="mt-3 text-danger"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const msgEl = document.getElementById('loginMessage');
    msgEl.textContent = '';
    const formData = new FormData(e.target);
    const payload = Object.fromEntries(formData);

    try {
        const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (res.ok && data.success && data.token) {
            // Store in localStorage using auth.js helper
            storeToken(data.token, data.user);
            
            // Also store in cookies for server-side rendering
            const maxAge = 24 * 60 * 60; // 1 day in seconds
            document.cookie = 'token=' + data.token + '; path=/; max-age=' + maxAge;
            document.cookie = 'user=' + encodeURIComponent(JSON.stringify(data.user)) + '; path=/; max-age=' + maxAge;
            
            // Redirect via server to set session properly
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/auth/set-session';
            form.style.display = 'none';
            
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = 'token';
            tokenInput.value = data.token;
            form.appendChild(tokenInput);
            
            const userInput = document.createElement('input');
            userInput.type = 'hidden';
            userInput.name = 'user';
            userInput.value = JSON.stringify(data.user);
            form.appendChild(userInput);
            
            document.body.appendChild(form);
            form.submit();
        } else {
            msgEl.textContent = data.message || data.error || 'Login failed';
        }
    } catch (err) {
        msgEl.textContent = 'Network error';
        console.error(err);
    }
});
</script>